name: Notify Discord on Push

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∫–æ–º–º–∏—Ç–µ
        id: gitinfo
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty="%an")
          
          # –û–ø—Ä–µ–¥–µ–ª–∏–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–æ–º–º–∏—Ç –ø–µ—Ä–≤—ã–º
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            # –ù–µ –ø–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | paste -sd ", " -)
          else
            # –ü–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç ‚Äî –±–µ—Ä—ë–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ª–æ–≥–æ–≤
            CHANGED_FILES=$(git log -1 --name-only --pretty="" | paste -sd ", " -)
          fi
          
          echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"üì¶ –ù–æ–≤—ã–π –ø—É—à –æ—Ç ${{ github.actor }} –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ${{ github.repository }}!\nüë§ –ê–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–∞: ${{ steps.gitinfo.outputs.author }}\nüìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${{ steps.gitinfo.outputs.message }}\nüìÇ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: ${{ steps.gitinfo.outputs.files }}\"
               }" \
               $DISCORD_WEBHOOK
