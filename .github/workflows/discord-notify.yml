name: Notify Discord on Push

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3

      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∫–æ–º–º–∏—Ç–µ
        id: gitinfo
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_MESSAGE=$(git log -1 --format=%B)
          COMMIT_AUTHOR=$(git log -1 --format="%an")
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_SHA | paste -sd ", " -)

          echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"üì¶ –ù–æ–≤—ã–π –ø—É—à –æ—Ç ${{ github.actor }} –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ${{ github.repository }}!\nüë§ –ê–≤—Ç–æ—Ä –∫–æ–º–º–∏—Ç–∞: ${{ steps.gitinfo.outputs.author }}\nüìù –°–æ–æ–±—â–µ–Ω–∏–µ: ${{ steps.gitinfo.outputs.message }}\nüìÇ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã: ${{ steps.gitinfo.outputs.files }}\"
               }" \
               $DISCORD_WEBHOOK
